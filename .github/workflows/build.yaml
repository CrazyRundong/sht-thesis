# from fduthesis: https://github.com/stone-zeng/fduthesis/blob/master/.github/workflows/test.yml

name: build

on:
  - push
  - pull_request

env:
  CTAN_URL: http://mirror.ctan.org
  NOTO_URL: https://noto-website-2.storage.googleapis.com/pkgs
  BUILD_DIR: build
  SED_REP: s/\\documentclass/\\documentclass\[fontset=none\]/
  SED_REP_WITH_CLS_ARGS: s/\\documentclass\[\(.*\)\]/\\documentclass\[\1, fontset=none\]/

jobs:
  build-ubuntu:
    name: Build on Ubuntu
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.head_commit.message, '[ci ubuntu]') || !contains(github.event.head_commit.message, '[ci skip]') }}
    steps:
      - uses: actions/checkout@v2
      - name: Install Noto and Times fonts
        run: |
          sudo apt-get update
          echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | sudo debconf-set-selections
          sudo apt-get install --yes fonts-noto-cjk fonts-noto-cjk-extra ttf-mscorefonts-installer
      - name: Install TeX Live
        run: |
          export PATH=/tmp/texlive/bin/x86_64-linux:$PATH
          curl -OL ${{ env.CTAN_URL }}/systems/texlive/tlnet/install-tl-unx.tar.gz
          tar -zxf install-tl-unx.tar.gz
          pushd install-tl-20* && chmod +x install-tl
          ./install-tl --profile ../.github/workflows/texlive.profile --repository ${{ env.CTAN_URL }}/systems/texlive/tlnet/
          popd
          cat DEPENDS.txt | tr "\n" " " | xargs tlmgr install
          echo "::set-env name=PATH::/tmp/texlive/bin/x86_64-linux:$PATH"
      - name: Build user document (LuaLaTeX)
        run: |
          sed -i '${{ env.SED_REP_WITH_CLS_ARGS }}' shtthesis-user-guide.tex
          latexmk -pdflua -time -outdir=${{ env.BUILD_DIR }}/lualatex
      - name: Build user document (XeLaTeX)
        if: success() || failure()
        run: |
          latexmk -pdfxe -time -outdir=${{ env.BUILD_DIR }}/xelatex
      - name: Archive build outputs
        if: success() || failure()
        uses: actions/upload-artifact@v2
        with:
          name: ubuntu-build
          path: ${{ env.BUILD_DIR }}
  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    if: ${{ contains(github.event.head_commit.message, '[ci macos]') || !contains(github.event.head_commit.message, '[ci skip]') }}
    steps:
      - uses: actions/checkout@v2
      - name: Install utilities
        run: |
          brew install gnu-sed
      - name: Install Noto fonts
        run: |
          for i in NotoSerifCJK NotoSansCJK; do curl -O ${{ env.NOTO_URL }}/$i.ttc.zip; done
          unzip -o "*.zip"
          cp -vf *.ttc /Library/Fonts/
      - name: Install TeX Live
        run: |
          export PATH=/tmp/texlive/bin/x86_64-darwin:$PATH
          curl -OL ${{ env.CTAN_URL }}/systems/texlive/tlnet/install-tl-unx.tar.gz
          tar -zxf install-tl-unx.tar.gz
          pushd install-tl-20* && chmod +x install-tl
          ./install-tl --profile ../.github/workflows/texlive.profile --repository ${{ env.CTAN_URL }}/systems/texlive/tlnet/
          popd
          cat DEPENDS.txt | tr "\n" " " | xargs tlmgr install
          echo "::set-env name=PATH::/tmp/texlive/bin/x86_64-darwin:$PATH"
      - name: Build user document (LuaLaTeX)
        run: |
          gsed -i '${{ env.SED_REP_WITH_CLS_ARGS }}' shtthesis-user-guide.tex
          latexmk -pdflua -time -outdir=${{ env.BUILD_DIR }}/lualatex
      - name: Build user document (XeLaTeX)
        if: success() || failure()
        run: |
          latexmk -pdfxe -time -outdir=${{ env.BUILD_DIR }}/xelatex
      - name: Archive build outputs
        if: success() || failure()
        uses: actions/upload-artifact@v2
        with:
          name: macos-build
          path: ${{ env.BUILD_DIR }}
  build-windows:
    runs-on: windows-latest
    name: Build on Windows
    if: ${{ contains(github.event.head_commit.message, '[ci windows]') || !contains(github.event.head_commit.message, '[ci skip]') }}
    steps:
      - uses: actions/checkout@v2
      - name: Install TeX Live
        run: |
          ${env:PATH} = "${{ github.workspace }}\tmp\texlive\bin\win32;" + ${env:PATH}
          Invoke-WebRequest -Uri ${{ env.CTAN_URL }}/systems/texlive/tlnet/install-tl.zip -OutFile install-tl.zip
          Invoke-WebRequest -Uri ${{ env.CTAN_URL }}/systems/win32/w32tex/TLW64/tl-win64.zip -OutFile tl-win64.zip
          Expand-Archive install-tl.zip -DestinationPath .
          Push-Location install-tl-*
          .\install-tl-windows --no-gui --profile ..\.github\workflows\texlive-win.profile --repository ${{ env.CTAN_URL }}/systems/texlive/tlnet/
          Pop-Location
          &tlmgr install @(Get-Content DEPENDS.txt)
          Expand-Archive tl-win64.zip -DestinationPath ${{ github.workspace }}\tmp\texlive
          $tl_path_w64 = "${{ github.workspace }}\tmp\texlive\bin\win64;" + "${{ github.workspace }}\tmp\texlive\bin\win32;" + ${env:PATH}
          echo "::set-env name=PATH::$tl_path_w64"
      - name: Install utilities
        run: |
          choco install sed
          choco install ghostscript --version=9.52
          $util_path = "C:\Program Files\gs\gs9.52\bin;" + ${env:PATH}
          echo "::set-env name=PATH::$util_path"
      - name: Install Noto fonts
        run: |
          "NotoSerifCJK-Regular", "NotoSerifCJK-Bold", "NotoSansCJK-Regular", "NotoSansCJK-Bold", "NotoSansCJK-Medium" | ForEach-Object -Process {Invoke-WebRequest -Uri "${{ env.NOTO_URL }}/$_.ttc.zip" -OutFile "$_.ttc.zip"}
          Get-ChildItem *.ttc.zip | Expand-Archive -DestinationPath . -Force
          Copy-Item *.ttc C:\Windows\Fonts
          fc-cache -fsv
          luaotfload-tool -fuv
      - name: Build user document (LuaLaTeX)
        run: |
          sed -i '${{ env.SED_REP_WITH_CLS_ARGS }}' shtthesis-user-guide.tex
          latexmk -pdflua -time -outdir=${{ env.BUILD_DIR }}/lualatex
      - name: Build user document (XeLaTeX)
        if: success() || failure()
        run: |
          latexmk -pdfxe -time -outdir=${{ env.BUILD_DIR }}/xelatex
      - name: Archive build outputs
        if: success() || failure()
        uses: actions/upload-artifact@v2
        with:
          name: windows-build
          path: ${{ env.BUILD_DIR }}
